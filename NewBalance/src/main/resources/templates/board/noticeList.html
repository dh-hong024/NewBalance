<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
공지사항 리스트

    <table id="noticesTable" class="table table-striped">
        <thead>
        <tr>
            <th>#</th>
            <th>제목</th>
            <th>등록일</th>
            <th>조회수</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="notice : ${notices}">
            <td th:text="${notice.id}"></td>
            <td>
                <a href="" th:href="@{/notice/notice-detail/{noticeId}(noticeId=${notice.id})}" th:text="${notice.noticeTitle}"></a>
            </td>
            <td th:text="${#temporals.format(notice.modifiedDate, 'yyyy-MM-dd')}"></td>
            <td th:text="${notice.noticeCount}"></td>
        </tr>

        </tbody>
    </table>

    <button th:onclick="|location.href='@{/notice/notice-form}'|"  sec:authorize="hasRole('ROLE_ADMIN')">글쓰기</button>

    <button id="loadMore" th:text="'더보기('+${totalNotices}+')'" >더보기</button>

</body>
<script>

    function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }


    let offset = 0;
    const limit = 10; //한 페이지에 표시할 데이터 개수

    function loadNotices() {
        $.get('/api/notices', { offset: offset, limit: limit })
            .done(function(data) {
                if (data.notices.length > 0) {
                    const notices = data.notices;
                    const noticesTable = $('#noticesTable tbody');
                        notices.forEach(notice => {
                            const link = '<a href="/notice/noticeDetail/' + notice.id + '">' + notice.noticeTitle + '</a>';
                            const formattedDate = formatDate(notice.modifiedDate);
                            noticesTable.append(
                                '<tr>' +
                                '<td>' + notice.id +'</td>' +
                                '<td>' + link + '</td>' +
                                '<td>' + formattedDate + '</td>' +
                                '<td>' + notice.noticeCount + '</td>' +
                                '</tr>');
                    });

                    offset += limit;

                    //남은 카운트 출력
                    const remingCount = Math.max(0, data.totalNotices - offset); // 음수 값이 나올 경우 0으로 처리
                    $('#loadMore').text('더보기('+remingCount+')');

                    // 더보기 버튼 표시 여부 결정
                    if(remingCount <= 0) {
                        $('#loadMore').hide();
                    }
                } else {
                    $('#loadMore').prop('disabled', true).text('마지막 글입니다.');
                    // 서버에서 반환된 데이터에 notices가 없거나 비어 있는 경우에 대한 처리를 추가합니다.
                }
            })
            .fail(function() {
                alert('Error loading');
            });
    }

    $(document).ready(function() {
        $('#loadMore').click(function() {
            loadNotices();
        });
    });
</script>


</html>
